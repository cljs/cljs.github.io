<html><head><meta charset="utf-8" /><meta content="IE=edge" http-equiv="X-UA-Compatible" /><meta content="width=device-width, initial-scale=1" name="viewport" /><title></title><meta name="description" /><link href="http://fonts.googleapis.com/css?family=Raleway:400,300,600,700" rel="stylesheet" /><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet" /><link href="/css/normalize.css" rel="stylesheet" /><link href="/css/skeleton.css" rel="stylesheet" /><link href="/css/custom.css" rel="stylesheet" /><link href="/css/github-theme.css" rel="stylesheet" /><link href="/img/icons/apple-touch-icon-57x57.png" rel="apple-touch-icon" sizes="57x57" /><link href="/img/icons/apple-touch-icon-114x114.png" rel="apple-touch-icon" sizes="114x114" /><link href="/img/icons/apple-touch-icon-72x72.png" rel="apple-touch-icon" sizes="72x72" /><link href="/img/icons/apple-touch-icon-144x144.png" rel="apple-touch-icon" sizes="144x144" /><link href="/img/icons/apple-touch-icon-60x60.png" rel="apple-touch-icon" sizes="60x60" /><link href="/img/icons/apple-touch-icon-120x120.png" rel="apple-touch-icon" sizes="120x120" /><link href="/img/icons/apple-touch-icon-76x76.png" rel="apple-touch-icon" sizes="76x76" /><link href="/img/icons/apple-touch-icon-152x152.png" rel="apple-touch-icon" sizes="152x152" /><link href="/img/icons/apple-touch-icon-180x180.png" rel="apple-touch-icon" sizes="180x180" /><link href="/img/icons/favicon-192x192.png" rel="icon" sizes="192x192" type="image/png" /><link href="/img/icons/favicon-160x160.png" rel="icon" sizes="160x160" type="image/png" /><link href="/img/icons/favicon-96x96.png" rel="icon" sizes="96x96" type="image/png" /><link href="/img/icons/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png" /><link href="/img/icons/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png" /></head><body><div class="container"><nav class="navbar"><div class="container"><ul class="navbar-list"><li class="navbar-item"><a class="navbar-link-logo"><img class="navbar-logo" src="/img/cljs-white.svg" /></a></li><li class="navbar-item"><a class="navbar-title">ClojureScript</a></li><li class="navbar-item"><a class="navbar-link" href="/docs">Docs</a></li><li class="navbar-item"><a class="navbar-link" href="/news">News</a></li></ul></div></nav><div><h1>cljs.core/TransientHashMap</h1><table><tr><td>type</td><td>Added in 0.0-1211</td><td><a href="https://github.com/clojure/clojure/blob/clojure-1.8.0/src/jvm/clojure/lang/PersistentHashMap.java"><img height="24px" src="/img/clojure-icon.gif" valign="middle" /> clojure.lang/TransientHashMap</a></td></tr></table><ul><li><code>(TransientHashMap. edit root count has-nil? nil-val)</code></li></ul><hr /><div>Source code @ <a href="https://github.com/clojure/clojurescript/blob/r1.8.51/src/main/cljs/cljs/core.cljs#L7152-L7253">clojurescript:src/main/cljs/cljs/core.cljs</a></div><pre><code>(<span class="hljs-name"><span class="hljs-builtin-name">deftype</span></span> TransientHashMap [^<span class="hljs-symbol">:mutable</span> <span class="hljs-comment">^boolean</span> edit
                           ^<span class="hljs-symbol">:mutable</span> root
                           ^<span class="hljs-symbol">:mutable</span> count
                           ^<span class="hljs-symbol">:mutable</span> <span class="hljs-comment">^boolean</span> has-nil?
                           ^<span class="hljs-symbol">:mutable</span> <span class="hljs-literal">nil</span>-val]
  Object
  (<span class="hljs-name"><span class="hljs-builtin-name">conj!</span></span> [tcoll o]
    (<span class="hljs-name"><span class="hljs-builtin-name">if</span></span> edit
      (<span class="hljs-name"><span class="hljs-builtin-name">if</span></span> (<span class="hljs-name">satisfies?</span> IMapEntry o)
        (<span class="hljs-name">.assoc!</span> tcoll (<span class="hljs-name"><span class="hljs-builtin-name">key</span></span> o) (<span class="hljs-name"><span class="hljs-builtin-name">val</span></span> o))
        (<span class="hljs-name"><span class="hljs-builtin-name">loop</span></span> [es (<span class="hljs-name"><span class="hljs-builtin-name">seq</span></span> o) tcoll tcoll]
          (<span class="hljs-name"><span class="hljs-builtin-name">if-let</span></span> [e (<span class="hljs-name"><span class="hljs-builtin-name">first</span></span> es)]
            (<span class="hljs-name"><span class="hljs-builtin-name">recur</span></span> (<span class="hljs-name"><span class="hljs-builtin-name">next</span></span> es)
                   (<span class="hljs-name">.assoc!</span> tcoll (<span class="hljs-name"><span class="hljs-builtin-name">key</span></span> e) (<span class="hljs-name"><span class="hljs-builtin-name">val</span></span> e)))
            tcoll)))
      (<span class="hljs-name"><span class="hljs-builtin-name">throw</span></span> (<span class="hljs-name">js/Error.</span> <span class="hljs-string">"conj! after persistent"</span>))))

  (<span class="hljs-name"><span class="hljs-builtin-name">assoc!</span></span> [tcoll k v]
    (<span class="hljs-name"><span class="hljs-builtin-name">if</span></span> edit
      (<span class="hljs-name"><span class="hljs-builtin-name">if</span></span> (<span class="hljs-name"><span class="hljs-builtin-name">nil?</span></span> k)
        (<span class="hljs-name"><span class="hljs-builtin-name">do</span></span> (<span class="hljs-name"><span class="hljs-builtin-name">if</span></span> (<span class="hljs-name">identical?</span> <span class="hljs-literal">nil</span>-val v)
              <span class="hljs-literal">nil</span>
              (<span class="hljs-name"><span class="hljs-builtin-name">set!</span></span> <span class="hljs-literal">nil</span>-val v))
            (<span class="hljs-name"><span class="hljs-builtin-name">if</span></span> has-nil?
              <span class="hljs-literal">nil</span>
              (<span class="hljs-name"><span class="hljs-builtin-name">do</span></span> (<span class="hljs-name"><span class="hljs-builtin-name">set!</span></span> count (<span class="hljs-name"><span class="hljs-builtin-name">inc</span></span> count))
                  (<span class="hljs-name"><span class="hljs-builtin-name">set!</span></span> has-nil? <span class="hljs-literal">true</span>)))
            tcoll)
        (<span class="hljs-name"><span class="hljs-builtin-name">let</span></span> [added-leaf? (<span class="hljs-name">Box.</span> <span class="hljs-literal">false</span>)
              node        (<span class="hljs-name"><span class="hljs-builtin-name">-&gt;</span></span> (<span class="hljs-name"><span class="hljs-builtin-name">if</span></span> (<span class="hljs-name"><span class="hljs-builtin-name">nil?</span></span> root)
                                (<span class="hljs-name">.-EMPTY</span> BitmapIndexedNode)
                                root)
                              (<span class="hljs-name">.inode-assoc!</span> edit <span class="hljs-number">0</span> (<span class="hljs-name">hash</span> k) k v added-leaf?))]
          (<span class="hljs-name"><span class="hljs-builtin-name">if</span></span> (<span class="hljs-name">identical?</span> node root)
            <span class="hljs-literal">nil</span>
            (<span class="hljs-name"><span class="hljs-builtin-name">set!</span></span> root node))
          (<span class="hljs-name"><span class="hljs-builtin-name">if</span></span> <span class="hljs-comment">^boolean</span> (<span class="hljs-name">.-val</span> added-leaf?)
            (<span class="hljs-name"><span class="hljs-builtin-name">set!</span></span> count (<span class="hljs-name"><span class="hljs-builtin-name">inc</span></span> count)))
          tcoll))
      (<span class="hljs-name"><span class="hljs-builtin-name">throw</span></span> (<span class="hljs-name">js/Error.</span> <span class="hljs-string">"assoc! after persistent!"</span>))))

  (<span class="hljs-name">without!</span> [tcoll k]
    (<span class="hljs-name"><span class="hljs-builtin-name">if</span></span> edit
      (<span class="hljs-name"><span class="hljs-builtin-name">if</span></span> (<span class="hljs-name"><span class="hljs-builtin-name">nil?</span></span> k)
        (<span class="hljs-name"><span class="hljs-builtin-name">if</span></span> has-nil?
          (<span class="hljs-name"><span class="hljs-builtin-name">do</span></span> (<span class="hljs-name"><span class="hljs-builtin-name">set!</span></span> has-nil? <span class="hljs-literal">false</span>)
              (<span class="hljs-name"><span class="hljs-builtin-name">set!</span></span> <span class="hljs-literal">nil</span>-val <span class="hljs-literal">nil</span>)
              (<span class="hljs-name"><span class="hljs-builtin-name">set!</span></span> count (<span class="hljs-name"><span class="hljs-builtin-name">dec</span></span> count))
              tcoll)
          tcoll)
        (<span class="hljs-name"><span class="hljs-builtin-name">if</span></span> (<span class="hljs-name"><span class="hljs-builtin-name">nil?</span></span> root)
          tcoll
          (<span class="hljs-name"><span class="hljs-builtin-name">let</span></span> [removed-leaf? (<span class="hljs-name">Box.</span> <span class="hljs-literal">false</span>)
                node (<span class="hljs-name">.inode-without!</span> root edit <span class="hljs-number">0</span> (<span class="hljs-name">hash</span> k) k removed-leaf?)]
            (<span class="hljs-name"><span class="hljs-builtin-name">if</span></span> (<span class="hljs-name">identical?</span> node root)
              <span class="hljs-literal">nil</span>
              (<span class="hljs-name"><span class="hljs-builtin-name">set!</span></span> root node))
            (<span class="hljs-name"><span class="hljs-builtin-name">if</span></span> (<span class="hljs-name">aget</span> removed-leaf? <span class="hljs-number">0</span>)
              (<span class="hljs-name"><span class="hljs-builtin-name">set!</span></span> count (<span class="hljs-name"><span class="hljs-builtin-name">dec</span></span> count)))
            tcoll)))
      (<span class="hljs-name"><span class="hljs-builtin-name">throw</span></span> (<span class="hljs-name">js/Error.</span> <span class="hljs-string">"dissoc! after persistent!"</span>))))

  (<span class="hljs-name"><span class="hljs-builtin-name">persistent!</span></span> [tcoll]
    (<span class="hljs-name"><span class="hljs-builtin-name">if</span></span> edit
      (<span class="hljs-name"><span class="hljs-builtin-name">do</span></span> (<span class="hljs-name"><span class="hljs-builtin-name">set!</span></span> edit <span class="hljs-literal">nil</span>)
          (<span class="hljs-name">PersistentHashMap.</span> <span class="hljs-literal">nil</span> count root has-nil? <span class="hljs-literal">nil</span>-val <span class="hljs-literal">nil</span>))
      (<span class="hljs-name"><span class="hljs-builtin-name">throw</span></span> (<span class="hljs-name">js/Error.</span> <span class="hljs-string">"persistent! called twice"</span>))))

  ICounted
  (<span class="hljs-name">-count</span> [coll]
    (<span class="hljs-name"><span class="hljs-builtin-name">if</span></span> edit
      count
      (<span class="hljs-name"><span class="hljs-builtin-name">throw</span></span> (<span class="hljs-name">js/Error.</span> <span class="hljs-string">"count after persistent!"</span>))))

  ILookup
  (<span class="hljs-name">-lookup</span> [tcoll k]
    (<span class="hljs-name"><span class="hljs-builtin-name">if</span></span> (<span class="hljs-name"><span class="hljs-builtin-name">nil?</span></span> k)
      (<span class="hljs-name"><span class="hljs-builtin-name">if</span></span> has-nil?
        <span class="hljs-literal">nil</span>-val)
      (<span class="hljs-name"><span class="hljs-builtin-name">if</span></span> (<span class="hljs-name"><span class="hljs-builtin-name">nil?</span></span> root)
        <span class="hljs-literal">nil</span>
        (<span class="hljs-name">.inode-lookup</span> root <span class="hljs-number">0</span> (<span class="hljs-name">hash</span> k) k))))

  (<span class="hljs-name">-lookup</span> [tcoll k not-found]
    (<span class="hljs-name"><span class="hljs-builtin-name">if</span></span> (<span class="hljs-name"><span class="hljs-builtin-name">nil?</span></span> k)
      (<span class="hljs-name"><span class="hljs-builtin-name">if</span></span> has-nil?
        <span class="hljs-literal">nil</span>-val
        not-found)
      (<span class="hljs-name"><span class="hljs-builtin-name">if</span></span> (<span class="hljs-name"><span class="hljs-builtin-name">nil?</span></span> root)
        not-found
        (<span class="hljs-name">.inode-lookup</span> root <span class="hljs-number">0</span> (<span class="hljs-name">hash</span> k) k not-found))))

  ITransientCollection
  (<span class="hljs-name">-conj!</span> [tcoll val] (<span class="hljs-name">.conj!</span> tcoll val))

  (<span class="hljs-name">-persistent!</span> [tcoll] (<span class="hljs-name">.persistent!</span> tcoll))

  ITransientAssociative
  (<span class="hljs-name">-assoc!</span> [tcoll key val] (<span class="hljs-name">.assoc!</span> tcoll key val))

  ITransientMap
  (<span class="hljs-name">-dissoc!</span> [tcoll key] (<span class="hljs-name">.without!</span> tcoll key)))</code></pre><hr /><div><a href="https://github.com/cljsinfo/cljs-api-docs/blob/master/cljsdoc/cljs.core/TransientHashMap.cljsdoc">Edit Here!</a></div></div><footer class="site-footer"><div class="wrapper"><hr /><div class="cljs-legal">ClojureScript is licensed <a href="http://opensource.org/licenses/eclipse-1.0.php">EPL 1.0</a><br />Copyright Â© Rich Hickey</div></div></footer></div></body></html>